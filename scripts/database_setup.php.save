<?php
/**
 * PhOD Hydrological Operations Dashboard
 * Database Setup Script
 * 
 * Table Creation structure: Core tables, Junction & Dependant tables, Position tables (CTD), Sampling tables
 */

echo "<h1>PhOD Database Setup</h1>";
echo "<p>Setting up PhOD Hydrological Operations Dashboard database...</p>";

try {
    // Connect to SQLite database
    $db = new PDO('sqlite:/var/www/phod/database/phod.db');
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    echo "<p style='color: green;'>✓ Connected to database</p>";

    // Enable foreign key support
    $db->exec("PRAGMA foreign_keys = ON");
    
    // Users table
    $db->exec("CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL UNIQUE,
        password TEXT NOT NULL,
        first_name TEXT NOT NULL,
        last_name TEXT NOT NULL,
        active INTEGER DEFAULT 1 CHECK (active IN (0, 1))
    )");
    
    // Roles table
    $db->exec("CREATE TABLE IF NOT EXISTS roles (
        role_id INTEGER PRIMARY KEY AUTOINCREMENT,
        role_name TEXT NOT NULL UNIQUE CHECK (role_name IN ('admin', 'bottlecop', 'console', 'observer', 'analyst', 'sampler')),
        role_description TEXT
    )");
    
    // Ships table
    $db->exec("CREATE TABLE IF NOT EXISTS ships (
        ship_id INTEGER PRIMARY KEY AUTOINCREMENT,
        ship_name TEXT NOT NULL UNIQUE,
        ship_number INTEGER UNIQUE,
        ship_abbreviation TEXT,
        active INTEGER DEFAULT 1 CHECK (active IN (0, 1))
    )");
    
    // Cruises table
    $db->exec("CREATE TABLE IF NOT EXISTS cruises (
        cruise_id INTEGER PRIMARY KEY AUTOINCREMENT,
        project_name TEXT NOT NULL,
        cruise_name TEXT NOT NULL,
        cruise_abbreviation TEXT,
        active INTEGER DEFAULT 1 CHECK (active IN (0, 1))
    )");
    
    // Stations table
    $db->exec("CREATE TABLE IF NOT EXISTS stations (
        station_id INTEGER PRIMARY KEY AUTOINCREMENT,
	cruise_id INTEGER NOT NULL,
        station_number TEXT NOT NULL,
        latitude REAL,
        longitude REAL,
        active INTEGER DEFAULT 1 CHECK (active IN (0, 1)),
	FOREIGN KEY (cruise_id) REFERENCES cruises(cruise_id) ON DELETE CASCADE
    )");
    
    //Sensor_Inventory table
    $db->exec("CREATE TABLE IF NOT EXISTS sensor_inventory (
        sensor_id INTEGER PRIMARY KEY AUTOINCREMENT,
        sensor_type TEXT NOT NULL,
        vin_number TEXT UNIQUE,
        status TEXT CHECK (status IN ('operational', 'maintenance', 'broken', 'retired')),
        in_use INTEGER DEFAULT 0 CHECK (in_use IN (0, 1)),
        backup_available INTEGER DEFAULT 0 CHECK (backup_available IN (0, 1)),
        notes TEXT
    )");
    
    // Niskin_Bottles table
    $db->exec("CREATE TABLE IF NOT EXISTS niskin_bottles (
        niskin_id INTEGER PRIMARY KEY AUTOINCREMENT,
        niskin_number INTEGER NOT NULL UNIQUE,
	serial_number TEXT,
        active INTEGER DEFAULT 1 CHECK (active IN (0, 1)),
        status TEXT CHECK (status IN ('ready', 'deployed', 'maintenance', 'broken')),
        notes TEXT
    )");
    
    // Sample_Types table
    $db->exec("CREATE TABLE IF NOT EXISTS sample_types (
        sample_type_id INTEGER PRIMARY KEY AUTOINCREMENT,
        type_name TEXT NOT NULL UNIQUE,
        abbreviation TEXT,
        description TEXT,
        active INTEGER DEFAULT 1 CHECK (active IN (0, 1))
    )");
    
	// User_Roles junction table
    $db->exec("CREATE TABLE IF NOT EXISTS user_roles (
        user_role_id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        role_id INTEGER NOT NULL,
        FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
        FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE CASCADE,
        UNIQUE(user_id, role_id)
    )");
	
    // CTD_Cast_Log table (central table)
    $db->exec("CREATE TABLE IF NOT EXISTS ctd_cast_log (
        ctd_cast_log_id INTEGER PRIMARY KEY AUTOINCREMENT,
        ship_id INTEGER NOT NULL,
        station_id INTEGER NOT NULL,
        cruise_id INTEGER NOT NULL,
        observer_user_id INTEGER NOT NULL,
        cast_number INTEGER NOT NULL,
        cast_date TEXT DEFAULT (date('now')),
        notes TEXT,
        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (ship_id) REFERENCES ships(ship_id),
        FOREIGN KEY (station_id) REFERENCES stations(station_id),
        FOREIGN KEY (cruise_id) REFERENCES cruises(cruise_id),
        FOREIGN KEY (observer_user_id) REFERENCES users(user_id)
    )");
    
    // Cast_Sensors table
    $db->exec("CREATE TABLE IF NOT EXISTS cast_sensors (
        cast_sensor_id INTEGER PRIMARY KEY AUTOINCREMENT,
        cast_log_id INTEGER NOT NULL,
        sensor_id INTEGER NOT NULL,
        position_order INTEGER CHECK (position_order > 0),
        sequence_number INTEGER CHECK (sequence_number > 0),
        notes TEXT,
        FOREIGN KEY (cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE,
        FOREIGN KEY (sensor_id) REFERENCES sensor_inventory(sensor_id)
    )");
    
    // Pre_Cast table
    $db->exec("CREATE TABLE IF NOT EXISTS pre_cast (
        pre_cast_id INTEGER PRIMARY KEY AUTOINCREMENT,
        cast_log_id INTEGER NOT NULL UNIQUE,
        pre_cast_pressure_test REAL CHECK (pre_cast_pressure_test >= 0),
        pre_cast_datetime TEXT,
        pre_cast_latitude REAL CHECK (pre_cast_latitude BETWEEN -90 AND 90),
        pre_cast_longitude REAL CHECK (pre_cast_longitude BETWEEN -180 AND 180),
        notes TEXT,
        FOREIGN KEY (cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE
    )");
    
    // Beginning_Position table
    $db->exec("CREATE TABLE IF NOT EXISTS beginning_position (
        begin_id INTEGER PRIMARY KEY AUTOINCREMENT,
        cast_log_id INTEGER NOT NULL UNIQUE,
        begin_datetime TEXT,
        begin_latitude REAL CHECK (begin_latitude BETWEEN -90 AND 90),
        begin_longitude REAL CHECK (begin_longitude BETWEEN -180 AND 180),
        begin_depth REAL CHECK (begin_depth >= 0),
        notes TEXT,
        FOREIGN KEY (cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE
    )");
    
    // At_Depth_Position table
    $db->exec("CREATE TABLE IF NOT EXISTS at_depth_position (
        at_depth_id INTEGER PRIMARY KEY AUTOINCREMENT,
        cast_log_id INTEGER NOT NULL UNIQUE,
        at_depth_datetime TEXT,
        at_depth_latitude REAL CHECK (at_depth_latitude BETWEEN -90 AND 90),
        at_depth_longitude REAL CHECK (at_depth_longitude BETWEEN -180 AND 180),
        at_depth_depth REAL CHECK (at_depth_depth >= 0),
        notes TEXT,
        FOREIGN KEY (cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE
    )");
    
    // Capture_Start table
    $db->exec("CREATE TABLE IF NOT EXISTS capture_start (
        capture_start_id INTEGER PRIMARY KEY AUTOINCREMENT,
        cast_log_id INTEGER NOT NULL UNIQUE,
        markscan_start INTEGER CHECK (markscan_start >= 0),
        markscan_start_datetime TEXT,
        notes TEXT,
        FOREIGN KEY (cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE
    )");
    
    // Bottom_Depth_Position table
    $db->exec("CREATE TABLE IF NOT EXISTS bottom_depth_position (
        bottom_position_id INTEGER PRIMARY KEY AUTOINCREMENT,
        cast_log_id INTEGER NOT NULL UNIQUE,
        height_above_bottom REAL CHECK (height_above_bottom >= 0),
        max_pressure REAL CHECK (max_pressure >= 0),
        winch_payout REAL CHECK (winch_payout >= 0),
        notes TEXT,
        FOREIGN KEY (cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE
    )");
    
    // Sample_Pressure table
    $db->exec("CREATE TABLE IF NOT EXISTS sample_pressure (
        sample_pressure_id INTEGER PRIMARY KEY AUTOINCREMENT,
        cast_log_id INTEGER NOT NULL,
        niskin_id INTEGER NOT NULL,
        sample_pressure_value REAL CHECK (sample_pressure_value >= 0),
        sample_captured INTEGER DEFAULT 0 CHECK (sample_captured IN (0, 1)),
        sample_captured_datetime TEXT,
        notes TEXT,
        FOREIGN KEY (cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE,
        FOREIGN KEY (niskin_id) REFERENCES niskin_bottles(niskin_id)
    )");
    
    // Ending_Position table
    $db->exec("CREATE TABLE IF NOT EXISTS ending_position (
        ending_id INTEGER PRIMARY KEY AUTOINCREMENT,
        cast_log_id INTEGER NOT NULL UNIQUE,
        end_datetime TEXT,
        end_latitude REAL CHECK (end_latitude BETWEEN -90 AND 90),
        end_longitude REAL CHECK (end_longitude BETWEEN -180 AND 180),
        end_depth REAL CHECK (end_depth >= 0),
        notes TEXT,
        FOREIGN KEY (cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE
    )");
    
    // On_Deck_Position table
    $db->exec("CREATE TABLE IF NOT EXISTS on_deck_position (
        on_deck_id INTEGER PRIMARY KEY AUTOINCREMENT,
        cast_log_id INTEGER NOT NULL UNIQUE,
        on_deck_datetime TEXT,
        on_deck_latitude REAL CHECK (on_deck_latitude BETWEEN -90 AND 90),
        on_deck_longitude REAL CHECK (on_deck_longitude BETWEEN -180 AND 180),
        notes TEXT,
        FOREIGN KEY (cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE
    )");
    
    // Post_Cast table
    $db->exec("CREATE TABLE IF NOT EXISTS post_cast (
        post_cast_id INTEGER PRIMARY KEY AUTOINCREMENT,
        ctd_cast_log_id INTEGER NOT NULL UNIQUE,
        post_cast_pressure_check REAL CHECK (post_cast_pressure_check >= 0),
        real_time_data_stop INTEGER DEFAULT 0 CHECK (real_time_data_stop IN (0, 1)),
        real_time_data_stop_datetime TEXT,
        deck_unit_off INTEGER DEFAULT 0 CHECK (deck_unit_off IN (0, 1)),
        deck_unit_off_datetime TEXT,
        notes TEXT,
        FOREIGN KEY (ctd_cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE
    )");
    
    // Bottles table
    $db->exec("CREATE TABLE IF NOT EXISTS bottles (
        bottle_id INTEGER PRIMARY KEY AUTOINCREMENT,
        niskin_id INTEGER NOT NULL,
        sample_type_id INTEGER NOT NULL,
        bottle_number INTEGER NOT NULL,
        is_duplicate INTEGER DEFAULT 0 CHECK (is_duplicate IN (0, 1)),
        duplicate_sequence INTEGER CHECK (duplicate_sequence > 0),
        capacity_ml INTEGER CHECK (capacity_ml > 0),
        status TEXT CHECK (status IN ('empty', 'filled', 'processed', 'archived')),
        collected_datetime TEXT,
        FOREIGN KEY (niskin_id) REFERENCES niskin_bottles(niskin_id),
        FOREIGN KEY (sample_type_id) REFERENCES sample_types(sample_type_id)
    )");
    
    // Bottle_Replacements table
    $db->exec("CREATE TABLE IF NOT EXISTS bottle_replacements (
        replacement_id INTEGER PRIMARY KEY AUTOINCREMENT,
        original_bottle_id INTEGER NOT NULL,
        replacement_bottle_id INTEGER NOT NULL,
        replacement_datetime TEXT DEFAULT CURRENT_TIMESTAMP,
        reason TEXT,
        notes TEXT,
        FOREIGN KEY (original_bottle_id) REFERENCES bottles(bottle_id),
        FOREIGN KEY (replacement_bottle_id) REFERENCES bottles(bottle_id)
    )");
    
    // Sampling_Session table
    $db->exec("CREATE TABLE IF NOT EXISTS sampling_session (
        session_id INTEGER PRIMARY KEY AUTOINCREMENT,
        ctd_cast_log_id INTEGER NOT NULL,
        on_deck_position_id INTEGER,
        sampling_start_datetime TEXT,
        sampling_end_datetime TEXT,
        notes TEXT,
        FOREIGN KEY (ctd_cast_log_id) REFERENCES ctd_cast_log(ctd_cast_log_id) ON DELETE CASCADE,
        FOREIGN KEY (on_deck_position_id) REFERENCES on_deck_position(on_deck_id)
    )");
    
    // Sample_Timing table
    $db->exec("CREATE TABLE IF NOT EXISTS sample_timing (
        timing_id INTEGER PRIMARY KEY AUTOINCREMENT,
        sample_type_id INTEGER NOT NULL,
        session_id INTEGER NOT NULL,
        set_by_user_id INTEGER NOT NULL,
        time_limit_hours INTEGER CHECK (time_limit_hours > 0),
        deadline_datetime TEXT,
        set_datetime TEXT DEFAULT CURRENT_TIMESTAMP,
        notes TEXT,
        FOREIGN KEY (sample_type_id) REFERENCES sample_types(sample_type_id),
        FOREIGN KEY (session_id) REFERENCES sampling_session(session_id) ON DELETE CASCADE,
        FOREIGN KEY (set_by_user_id) REFERENCES users(user_id)
    )");

    echo "<p style='color: green;'>✓ All tables created successfully!</p>";
    
    // Insert default roles
    $roles = [
        ['admin', 'System administrator with full access'],
        ['bottlecop', 'Bottle operations coordinator'],
        ['console', 'Observer/Console operator'],
        ['analyst', 'Sample analyzer'],
        ['sampler', 'Sample collector']
    ];
    
    $stmt = $db->prepare("INSERT OR IGNORE INTO roles (role_name, role_description) VALUES (?, ?)");
    foreach ($roles as $role) {
        $stmt->execute($role);
    }
    
    echo "<p style='color: green;'>✓ Default roles inserted</p>";
    
    // Insert sample types
    $sample_types = [
	['Oxygen', 'O2', 'Dissolved oxygen samples'],
	['Oxygen Duplicate', 'O2-DUP', 'Duplicate dissolved oxygen samples'],
	['Total Alkalinity', 'TA', 'Total alkalinity measurement'],
	['Total Alkalinity Duplicate', 'TA-DUP', 'Duplicate total alkalinity samples'],
	['Dissolved Inorganic Carbon', 'DIC', 'Dissolved inorganic carbon measurement'], 
	['Dissolved Inorganic Carbon Duplicate', 'DIC-DUP', 'Duplicate dissolved inorganic carbon samples'],
	['pH', 'PH', 'Potential of hydrogen measurement'],
	['pH Duplicate', 'PH-DUP', 'Duplicate pH samples'],
	['Nutrients', 'NUTS', 'Nutrient analysis samples'],
	['Nutrients Duplicate', 'NUTS-DUP', 'Duplicate nutrient samples'],
	['Salinity', 'SAL', 'Salinity measurement samples'],
	['Salinity Duplicate', 'SAL-DUP', 'Duplicate Salinity samples'],
	['MAC Samples', 'MAC', 'MAC analysis samples'],
	['Reference Water', 'REF', 'Reference water samples']
    ];
    
    $stmt = $db->prepare("INSERT OR IGNORE INTO sample_types (type_name, abbreviation, description) VALUES (?, ?, ?)");
    foreach ($sample_types as $type) {
        $stmt->execute($type);
    }
    
    echo "<p style='color: green;'>✓ Default sample types inserted</p>";

   // Insert sensor inventory data (static equipment)
   echo "<p>Adding sensor inventory...</p>";

   $sensors_data = [
   // [sensor_type, vin_number, status, in_use, backup_available, notes]
	['Autosal', '59748', 'operational', 0, 0, null],
	['Autosal', '60555', 'operational', 0, 0, null],
	['Autosal', '71011', 'operational', 0, 0, null],
	['Carousel', '328531-0032', 'operational', 0, 0, '24 position with hub'],
	['Carousel', '260142-0794', 'operational', 0, 0, '24 position with hub'],
	['Carousel', '32-0980', 'operational', 0, 0, '24 position with hub'],
	['Carousel', '32-0975', 'operational', 0, 0, '24 position with hub'],
	['Pump', '1268', 'operational', 0, 0, 'SBE 05T slum, 3000 rpm'],
	['Pump', '7268', 'operational', 0, 0, 'SBE 05T slum, 3000 rpm'],
	['Pump', '7739', 'operational', 0, 0, 'SBE 05T slum, 3000 rpm'],
	['Oxygen', '2691', 'operational', 0, 0, 'SBE 43 dissolved oxygen sensor'],
	['Oxygen', '2082', 'operational', 0, 0, 'SBE 43 dissolved oxygen sensor'],
	['Oxygen', '2934', 'operational', 0, 0, 'SBE 43 dissolved oxygen sensor'],
	['Conductivity', '3861', 'operational', 0, 0, 'SBE 04C conductivity module'],
	['Conductivity', '4229', 'operational', 0, 0, 'SBE 04C conductivity module'],
	['Conductivity', '4349', 'operational', 0, 0, 'SBE 04C conductivity module'],
	['Temperature', '5237', 'operational', 0, 0, 'SBE 03P temperature module'],
	['Temperature', '5889', 'operational', 0, 0, 'SBE 03P temperature module'],
	['Temperature', '5348', 'operational', 0, 0, 'SBE 03P temperature module'],
	['Pressure', '0363', 'operational', 0, 0, 'pressure pressure'],
	['Pressure', '95798', 'operational', 0, 0, 'pressure pressure'],
	['Pressure', '23896', 'operational', 0, 0, 'pressure pressure']
   ];

   $stmt = $db->prepare("INSERT OR IGNORE INTO sensor_inventory 
   	(sensor_type, vin_number, status, in_use, backup_available, notes) 
   	VALUES (?, ?, ?, ?, ?, ?)");

   foreach ($sensors_data as $sensor) {
   	$stmt->execute($sensor);
   }

   echo "<p style='color: green;'>✓ " . count($sensors_data) . " sensors added to inventory</p>";

   // Insert all 24 Niskin bottles with serial numbers
   echo "<p>Adding Niskin bottle inventory...</p>";

   $niskin_bottles = [
   // [niskin_number, serial_number, active, status, notes]
   	[1, 'NK-001', 1, 'ready', 'Niskin bottle #1'],
        [2, 'NK-002', 1, 'ready', 'Niskin bottle #2'],
        [3, 'NK-003', 1, 'ready', 'Niskin bottle #3'],
    	[4, 'NK-004', 1, 'ready', 'Niskin bottle #4'],
    	[5, 'NK-005', 1, 'ready', 'Niskin bottle #5'],
    	[6, 'NK-006', 1, 'ready', 'Niskin bottle #6'],
    	[7, 'NK-007', 1, 'ready', 'Niskin bottle #7'],
    	[8, 'NK-008', 1, 'ready', 'Niskin bottle #8'],
    	[9, 'NK-009', 1, 'ready', 'Niskin bottle #9'],
    	[10, 'NK-010', 1, 'ready', 'Niskin bottle #10'],
    	[11, 'NK-011', 1, 'ready', 'Niskin bottle #11'],
    	[12, 'NK-012', 1, 'ready', 'Niskin bottle #12'],
    	[13, 'NK-013', 1, 'ready', 'Niskin bottle #13'],
    	[14, 'NK-014', 1, 'ready', 'Niskin bottle #14'],
    	[15, 'NK-015', 1, 'ready', 'Niskin bottle #15'],
    	[16, 'NK-016', 1, 'ready', 'Niskin bottle #16'],
    	[17, 'NK-017', 1, 'ready', 'Niskin bottle #17'],
    	[18, 'NK-018', 1, 'ready', 'Niskin bottle #18'],
    	[19, 'NK-019', 1, 'ready', 'Niskin bottle #19'],
    	[20, 'NK-020', 1, 'ready', 'Niskin bottle #20'],
    	[21, 'NK-021', 1, 'ready', 'Niskin bottle #21'],
    	[22, 'NK-022', 1, 'ready', 'Niskin bottle #22'],
    	[23, 'NK-023', 1, 'ready', 'Niskin bottle #23'],
    	[24, 'NK-024', 1, 'ready', 'Niskin bottle #24']
   ];

   $stmt = $db->prepare("INSERT OR IGNORE INTO niskin_bottles 
   	(niskin_number, serial_number, active, status, notes) 
   	VALUES (?, ?, ?, ?, ?)");

   foreach ($niskin_bottles as $niskin) {
   	$stmt->execute($niskin);
   }

   echo "<p style='color: green;'>✓ " . count($niskin_bottles) . " Niskin bottles added to inventory</p>";

   // Insert complete bottle inventory with pseudo data
   echo "<p>Adding complete bottle inventory...</p>";

   $bottles_data = [];

   // Oxygen bottles (10 bottles) - real data
   $oxygen_bottles = [
   	[1, 1, 1001, 0, null, 138.863, 'empty'],
    	[2, 1, 1002, 0, null, 136.272, 'empty'],
   	[3, 1, 1003, 0, null, 145.526, 'empty'],
    	[4, 1, 1004, 0, null, 140.948, 'empty'],
    	[5, 1, 1005, 0, null, 142.183, 'empty'],
    	[6, 1, 1006, 0, null, 144.768, 'empty'],
    	[7, 1, 1007, 0, null, 143.813, 'empty'],
    	[8, 1, 1008, 0, null, 143.786, 'empty'],
    	[9, 1, 1009, 0, null, 144.679, 'empty'],
    	[10, 1, 1010, 0, null, 142.102, 'empty']
   ];
   $bottles_data = array_merge($bottles_data, $oxygen_bottles);

   // Total Alkalinity bottles (10 bottles) - pseudo data
   $ta_volumes = [125.000, 126.500, 124.800, 125.200, 125.800, 124.900, 125.600, 125.300, 124.700, 125.400];
   for ($i = 1; $i <= 10; $i++) {
   	$niskin_id = $i + 10; // Niskins 11-20
   	$bottle_number = 2000 + $i; // 2001-2010
   	$bottles_data[] = [$niskin_id, 3, $bottle_number, 0, null, $ta_volumes[$i-1], 'empty'];
   }

   // DIC bottles (10 bottles) - pseudo data (typically larger bottles)
   $dic_volumes = [250.000, 252.000, 248.000, 251.000, 249.500, 250.500, 251.500, 249.000, 252.500, 250.200];
   for ($i = 1; $i <= 10; $i++) {
   	$niskin_id = ($i > 4) ? $i - 4 : $i + 20; // Niskins 21-24, then 1-6
   	$bottle_number = 3000 + $i; // 3001-3010
   	$bottles_data[] = [$niskin_id, 5, $bottle_number, 0, null, $dic_volumes[$i-1], 'empty'];
   }

   // pH bottles (10 bottles) - pseudo data
   $ph_volumes = [180.000, 182.000, 178.000, 181.000, 179.500, 180.500, 181.500, 179.000, 182.500, 180.200];
   for ($i = 1; $i <= 10; $i++) {
   	$niskin_id = $i; // Niskins 1-10 (sharing with oxygen)
   	$bottle_number = 4000 + $i; // 4001-4010
   	$bottles_data[] = [$niskin_id, 7, $bottle_number, 0, null, $ph_volumes[$i-1], 'empty'];
   }

   // Nutrient bottles (10 bottles) - pseudo data 
   $nutrient_volumes = [60.000, 62.000, 58.000, 61.000, 59.500, 60.500, 61.500, 59.000, 62.500, 60.200];
   for ($i = 1; $i <= 10; $i++) {
   	$niskin_id = $i + 5; // Niskins 6-15
   	$bottle_number = 5000 + $i; // 5001-5010
   	$bottles_data[] = [$niskin_id, 9, $bottle_number, 0, null, $nutrient_volumes[$i-1], 'empty'];
   }

   // Salinity bottles (10 bottles) - pseudo data
   $salinity_volumes = [200.000, 202.000, 198.000, 201.000, 199.500, 200.500, 201.500, 199.000, 202.500, 200.200];
   for ($i = 1; $i <= 10; $i++) {
   	$niskin_id = $i + 10; // Niskins 11-20 (sharing with TA)
    	$bottle_number = 6000 + $i; // 6001-6010
    	$bottles_data[] = [$niskin_id, 11, $bottle_number, 0, null, $salinity_volumes[$i-1], 'empty'];
   }

   // MAC bottles (10 bottles) - pseudo data (varies by analysis type)
   $mac_volumes = [300.000, 305.000, 295.000, 302.000, 298.000, 301.000, 304.000, 297.000, 306.000, 299.000];
   for ($i = 1; $i <= 10; $i++) {
   	$niskin_id = $i + 14; // Niskins 15-24, wrapping if needed
   	if ($niskin_id > 24) $niskin_id = $niskin_id - 24;
   	$bottle_number = 7000 + $i; // 7001-7010
   	$bottles_data[] = [$niskin_id, 13, $bottle_number, 0, null, $mac_volumes[$i-1], 'empty'];
   }

   // Reference Water bottles (10 bottles) - pseudo data (standard volumes)
   $ref_volumes = [500.000, 500.000, 500.000, 500.000, 500.000, 500.000, 500.000, 500.000, 500.000, 500.000];
   for ($i = 1; $i <= 10; $i++) {
   	$niskin_id = $i + 14; // Niskins 15-24
   	$bottle_number = 8000 + $i; // 8001-8010
   	$bottles_data[] = [$niskin_id, 14, $bottle_number, 0, null, $ref_volumes[$i-1], 'empty'];
   }

   // Insert all bottles
   $stmt = $db->prepare("INSERT OR IGNORE INTO bottles 
   	(niskin_id, sample_type_id, bottle_number, is_duplicate, duplicate_sequence, capacity_ml, status) 
   	VALUES (?, ?, ?, ?, ?, ?, ?)");

   foreach ($bottles_data as $bottle) {
   	$stmt->execute($bottle);
   }



   // Create default admin user with hashed password
   echo "<p>Creating default admin user...</p>";

   // Check if admin user already exists
   $stmt = $db->prepare("SELECT COUNT(*) FROM users WHERE username = 'admin'");
   $stmt->execute();
   $admin_exists = $stmt->fetchColumn();

   if ($admin_exists == 0) {
       // Create admin user with HASHED password
       $hashed_password = password_hash('admin123', PASSWORD_DEFAULT);
       $stmt = $db->prepare("INSERT INTO users (username, password, first_name, last_name, active) VALUES (?, ?, ?, ?, ?)");
       $stmt->execute(['admin', $hashed_password, 'System', 'Administrator', 1]);
       $admin_user_id = $db->lastInsertId();
    
    // Get admin role ID
       $stmt = $db->prepare("SELECT role_id FROM roles WHERE role_name = 'admin'");
       $stmt->execute();
       $admin_role_id = $stmt->fetchColumn();
    
    // Assign admin role
    if ($admin_role_id && $admin_user_id) {
        $stmt = $db->prepare("INSERT INTO user_roles (user_id, role_id) VALUES (?, ?)");
        $stmt->execute([$admin_user_id, $admin_role_id]);
        echo "<p style='color: green;'>✓ Default admin user created with hashed password (username: admin, password: admin123)</p>";
    } else {
        echo "<p style='color: orange;'>⚠ Failed to assign admin role</p>";
    }
   } else {
   	echo "<p style='color: blue;'>ℹ Admin user already exists</p>";
   }


   echo "<p style='color: green;'>✓ " . count($bottles_data) . " bottles added to inventory</p>";
   echo "<p><strong>Complete equipment inventory added:</strong></p>";
   echo "<ul>";
   echo "<li>" . count($sensors_data) . " sensors (Autosal, Carousel, Pump, Oxygen, Conductivity, Temperature, Pressure)</li>";
   echo "<li>24 Niskin bottles with serial numbers (NK-001 to NK-024)</li>";
   echo "<li>80 sample bottles across 8 analysis types</li>";
   echo "</ul>";
   echo "<p><em>Note: Bottle volumes include real oxygen data and realistic pseudo data for other types.</em></p>";

    // Show created tables
    $tables = $db->query("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name")->fetchAll();
    echo "<h3>Created Tables (" . count($tables) . "):</h3><ul>";
    foreach ($tables as $table) {
        echo "<li>" . $table['name'] . "</li>";
    }
    echo "</ul>";
    
    // Show database info
    $db_size = filesize('/var/www/phod/database/phod.db');
    echo "<p><strong>Database file:</strong> /var/www/phod/database/phod.db</p>";
    echo "<p><strong>Database size:</strong> " . number_format($db_size) . " bytes</p>";
    
    echo "<h2 style='color: green;'>PhOD Database Setup Complete!</h2>";
    echo "<p>Your database is ready for use. You can now:</p>";
    echo "<ul>";
    echo "<li>Create user accounts and assign roles</li>";
    echo "<li>Add ships, cruises, and stations</li>";
    echo "<li>Register sensor inventory</li>";
    echo "<li>Start logging CTD casts and sampling sessions</li>";
    echo "</ul>";

} catch(PDOException $e) {
    echo "<p style='color: red;'>✗ Database Error: " . $e->getMessage() . "</p>";
    echo "<p>Line: " . $e->getLine() . "</p>";
}
?>
